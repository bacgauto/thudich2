<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üé§ Captions Live - Phi√™n b·∫£n c·∫£i ti·∫øn</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr 1fr 1fr;
      gap: 15px;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top right, rgba(0, 100, 100, 0.2) 0%, transparent 40%);
      pointer-events: none;
      z-index: -1;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      padding: 0 5px 15px;
      border-bottom: 1px solid rgba(0, 200, 200, 0.3);
    }
    
    .title {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(90deg, #00c9ff, #92fe9d);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    button {
      background: linear-gradient(135deg, #00c9ff, #00a5c9);
      color: white;
      padding: 12px 25px;
      font-size: 1em;
      font-weight: 600;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 201, 255, 0.5);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button.stop {
      background: linear-gradient(135deg, #ff416c, #ff4b2b);
      box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
    }
    
    button.stop:hover {
      box-shadow: 0 6px 20px rgba(255, 65, 108, 0.5);
    }
    
    .status {
      background: rgba(0, 0, 0, 0.4);
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status.active {
      color: #90ee90;
    }
    
    .status.inactive {
      color: #ff6b6b;
    }
    
    .block {
      padding: 20px;
      border-radius: 12px;
      white-space: pre-line;
      transition: all 0.3s ease;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      position: relative;
      line-height: 1.6;
      max-height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 1.1em;
      font-weight: 600;
      color: #00c9ff;
    }
    
    .block-content {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    /* Custom scrollbar */
    .block-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .block-content::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .block-content::-webkit-scrollbar-thumb {
      background: #00c9ff;
      border-radius: 3px;
    }
    
    #partial {
      background: linear-gradient(135deg, #003300, #001a00);
      color: #90ee90;
      font-size: 1.5em;
      font-weight: bold;
    }
    
    #final {
      background: linear-gradient(135deg, #222, #1a1a1a);
      font-size: 1.3em;
    }
    
    #translated {
      background: linear-gradient(135deg, #003366, #002244);
      color: #d0f0ff;
      font-size: 1.2em;
      font-style: italic;
    }
    
    .block:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.5);
    }
    
    .footer {
      text-align: center;
      padding: 20px 0 10px;
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.6);
    }
    
    @media (max-width: 768px) {
      body {
        grid-template-rows: auto auto auto auto auto;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .controls {
        width: 100%;
      }
      
      button {
        flex-grow: 1;
        justify-content: center;
      }
    }
    
    .pulse {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff416c;
      box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7);
      animation: pulse 2s infinite;
      margin-right: 5px;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 65, 108, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(255, 65, 108, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(255, 65, 108, 0);
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3V5M15.5 5.5L14 7M18 10H20M15.5 14.5L14 13M12 15V17M8.5 14.5L10 13M6 10H4M8.5 5.5L10 7" stroke="#00c9ff" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12C11 12.5523 11.4477 13 12 13Z" fill="#00c9ff"/>
        <path d="M19 12C19 15.866 15.866 19 12 19C8.13401 19 5 15.866 5 12C5 8.13401 8.13401 5 12 5C15.866 5 19 8.13401 19 12Z" stroke="#00c9ff" stroke-width="2"/>
      </svg>
      <span>CAPTIONS LIVE - PHI√äN B·∫¢N CAO C·∫§P</span>
    </div>
    
    <div class="controls">
      <button onclick="startFakeAudio()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 3V5.5M18 3V8.5M5.5 16.5L8 14.5V20.5L5.5 18.5M15 5.5L20 3V21L15 18.5V5.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        B·∫≠t √¢m thanh gi·∫£
      </button>
      <button class="stop" onclick="stopFakeAudio()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="5" width="4" height="14" rx="1" fill="white"/>
          <rect x="14" y="5" width="4" height="14" rx="1" fill="white"/>
        </svg>
        D·ª´ng √¢m thanh gi·∫£
      </button>
      <div id="recogStatus" class="status active">
        <span class="pulse"></span>
        ƒêang nh·∫≠n di·ªán gi·ªçng n√≥i...
      </div>
    </div>
  </div>
  
  <div id="partial" class="block" tabindex="0">
    <div class="block-header">
      <span>Nh·∫≠n di·ªán t·ª©c th·ªùi</span>
      <span>ƒêang ho·∫°t ƒë·ªông</span>
    </div>
    <div class="block-content" id="partial-content">
      [üéß ƒêang b·∫Øt ch·ªØ t·ª´ng ph·∫ßn...]
    </div>
  </div>
  
  <div id="final" class="block" tabindex="0">
    <div class="block-header">
      <span>VƒÉn b·∫£n ho√†n ch·ªânh</span>
      <span>ƒê√£ x√°c nh·∫≠n</span>
    </div>
    <div class="block-content" id="final-content"></div>
  </div>
  
  <div id="translated" class="block" tabindex="0">
    <div class="block-header">
      <span>B·∫£n d·ªãch ti·∫øng Anh</span>
      <span>ƒêang d·ªãch...</span>
    </div>
    <div class="block-content" id="translated-content"></div>
  </div>
  
  <div class="footer">
    Captions Live v2.0 | Ho·∫°t ƒë·ªông t∆∞∆°ng t·ª± ZipCaptions | Nh·∫≠n di·ªán gi·ªçng n√≥i th·ªùi gian th·ª±c
  </div>
  
  <audio id="fakeAudio" src="dummy.mp3" preload="auto" loop></audio>

  <script>
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. Vui l√≤ng s·ª≠ d·ª•ng Chrome ho·∫∑c Edge.");
      document.getElementById("recogStatus").className = "status inactive";
      document.getElementById("recogStatus").innerHTML = "Kh√¥ng h·ªó tr·ª£ Web Speech API";
    }

    const recog = new SpeechRecognition();
    recog.lang = "vi-VN";
    recog.continuous = true;
    recog.interimResults = true;
    recog.maxAlternatives = 1;

    const partialContent = document.getElementById("partial-content");
    const finalContent = document.getElementById("final-content");
    const translatedContent = document.getElementById("translated-content");
    const fakeAudio = document.getElementById("fakeAudio");
    const statusEl = document.getElementById("recogStatus");

    let fakeAudioPlaying = false;
    let idleTimeout;
    let lastFinalResult = "";
    let lastPartialResult = "";

    // H√†m kh·ªüi ƒë·ªông √¢m thanh gi·∫£
    function startFakeAudio() {
      if (!fakeAudioPlaying) {
        fakeAudio.volume = 0.01;
        fakeAudio.play().catch(err => console.log("L·ªói ph√°t √¢m gi·∫£:", err));
        fakeAudioPlaying = true;
        console.log("‚ñ∂ B·∫≠t √¢m thanh gi·∫£");
        statusEl.innerHTML = '<span class="pulse"></span> √Çm thanh gi·∫£ ƒëang ch·∫°y...';
      }
    }

    // H√†m d·ª´ng √¢m thanh gi·∫£
    function stopFakeAudio() {
      if (fakeAudioPlaying) {
        fakeAudio.pause();
        fakeAudio.currentTime = 0;
        fakeAudioPlaying = false;
        console.log("‚èπ D·ª´ng √¢m thanh gi·∫£");
        statusEl.innerHTML = '<span class="pulse"></span> ƒêang nh·∫≠n di·ªán gi·ªçng n√≥i...';
      }
    }

    // H√†m ƒë·∫∑t l·∫°i b·ªô ƒë·∫øm th·ªùi gian nh√†n r·ªói
    function resetIdleTimer() {
      clearTimeout(idleTimeout);
      idleTimeout = setTimeout(() => {
        console.log("ü§´ Kh√¥ng ph√°t hi·ªán ti·∫øng n√≥i ‚Üí b·∫≠t √¢m thanh gi·∫£");
        startFakeAudio();
      }, 5000);
    }

    // S·ª± ki·ªán khi c√≥ k·∫øt qu·∫£ nh·∫≠n di·ªán
    recog.onresult = async (e) => {
      resetIdleTimer();
      stopFakeAudio();
      
      let finalText = "";
      let partialText = "";
      
      for (let i = e.resultIndex; i < e.results.length; i++) {
        const result = e.results[i];
        const text = result[0].transcript.trim();
        
        if (result.isFinal) {
          // B·ªè qua c√°c c·ª•m t·ª´ kh√¥ng mong mu·ªën
          if (text.toLowerCase().includes("a nam ∆°i")) continue;
          
          // Th√™m d·∫•u c√°ch n·∫øu c·∫ßn
          if (lastFinalResult && !lastFinalResult.endsWith(' ') && !lastFinalResult.endsWith('\n')) {
            finalText += ' ';
          }
          
          finalText += text;
          lastFinalResult = text;
          
          // Th√™m v√†o khung k·∫øt qu·∫£ cu·ªëi c√πng
          if (finalContent.textContent.length > 0 && !finalContent.textContent.endsWith('\n')) {
            finalContent.textContent += ' ';
          }
          finalContent.textContent += text;
          
          // D·ªãch vƒÉn b·∫£n
          translate(text);
          
          // X√≥a n·ªôi dung t·∫°m th·ªùi
          partialContent.textContent = "";
          lastPartialResult = "";
        } else {
          // X·ª≠ l√Ω k·∫øt qu·∫£ t·∫°m th·ªùi
          partialText = text;
          lastPartialResult = text;
        }
      }
      
      // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi n·∫øu c√≥
      if (partialText) {
        partialContent.textContent = partialText;
      }
    };

    // S·ª± ki·ªán khi c√≥ l·ªói
    recog.onerror = e => {
      console.error("L·ªói nh·∫≠n di·ªán:", e.error);
      partialContent.textContent = "[L·ªói: " + e.error + "]";
      startFakeAudio();
      statusEl.innerHTML = '<span class="pulse"></span> ƒê√£ x·∫£y ra l·ªói - ƒêang th·ª≠ l·∫°i...';
    };

    // S·ª± ki·ªán khi k·∫øt th√∫c nh·∫≠n di·ªán
    recog.onend = () => {
      console.log("Nh·∫≠n di·ªán k·∫øt th√∫c - Kh·ªüi ƒë·ªông l·∫°i");
      setTimeout(() => {
        recog.start();
        statusEl.innerHTML = '<span class="pulse"></span> ƒêang nh·∫≠n di·ªán gi·ªçng n√≥i...';
      }, 300);
      startFakeAudio();
    };

    // S·ª± ki·ªán khi b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán
    recog.onstart = () => {
      console.log("Nh·∫≠n di·ªán b·∫Øt ƒë·∫ßu");
      statusEl.innerHTML = '<span class="pulse"></span> ƒêang nh·∫≠n di·ªán gi·ªçng n√≥i...';
    };

    // H√†m d·ªãch vƒÉn b·∫£n
    async function translate(text) {
      if (!text.trim()) return;
      
      try {
        const res = await fetch("https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=en&dt=t&q=" + encodeURIComponent(text));
        const data = await res.json();
        const translated = data[0].map(x => x[0]).join("");
        
        // Th√™m d·∫•u c√°ch n·∫øu c·∫ßn
        if (translatedContent.textContent.length > 0 && !translatedContent.textContent.endsWith('\n')) {
          translatedContent.textContent += ' ';
        }
        
        translatedContent.textContent += translated;
      } catch (err) {
        console.error("L·ªói d·ªãch thu·∫≠t:", err);
        translatedContent.textContent += "[L·ªói d·ªãch] ";
      }
    }

    // Kh·ªüi ƒë·ªông nh·∫≠n di·ªán gi·ªçng n√≥i
    if (SpeechRecognition) {
      recog.start();
      resetIdleTimer();
    }
    
    // T·ª± ƒë·ªông cu·ªôn khi n·ªôi dung m·ªõi ƒë∆∞·ª£c th√™m v√†o
    function autoScroll(element) {
      element.scrollTop = element.scrollHeight;
    }
    
    // Theo d√µi c√°c ph·∫ßn t·ª≠ ƒë·ªÉ t·ª± ƒë·ªông cu·ªôn
    [partialContent, finalContent, translatedContent].forEach(el => {
      const observer = new MutationObserver(() => autoScroll(el));
      observer.observe(el, { childList: true, subtree: true });
    });
  </script>
</body>
</html>